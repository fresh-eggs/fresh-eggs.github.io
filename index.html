<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; think_tank_sec</title>
<meta name="description" content="mostly planetary things.">
<meta name="keywords" content="computers">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="mostly planetary things.">
<meta property="og:url" content="/">
<meta property="og:site_name" content="think_tank_sec">





<link rel="canonical" href="/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="think_tank_sec Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/think_tank_sec.png" alt="Zack photo" class="author-photo">
					<h4>Zack</h4>
					<p>flipping bits since 93'</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:zack.thinktanksec@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				
				
				
				
				
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="/images/think_tank_banner_00.gif" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>think_tank_sec</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/2018/01/03/From-C-to-x86-part0x00-pointers.html" title="From C To X86 : Part0x00 Pointers"><img src="/images/think_tank_banner_02.jpg" alt="From C To X86 : Part0x00 Pointers"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2018-01-03T00:00:00-05:00"><a href="/2018/01/03/From-C-to-x86-part0x00-pointers.html">January 03, 2018</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Zack">Zack</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2018/01/03/From-C-to-x86-part0x00-pointers.html" rel="bookmark" title="From C To X86 : Part0x00 Pointers" itemprop="url">From C To X86 : Part0x00 Pointers</a></h1>
    
  </header>
  <div class="entry-content">
    <p>This is the first installment of the x86 series where we cover the basics of assembly from a C programmers perspective.</p>

<p>Today we will focus on the basics of pointers with the help of a simple C example.</p>

<p><br /><br /></p>
<h2 id="the-c-code">The C code</h2>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="n">our_char</span> <span class="o">=</span> <span class="sc">'Q'</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr_x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">our_char</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"this is your ptr_x addr: 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr_x</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"the value stored in ptr_x: 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ptr_x</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"here is the value it points to: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr_x</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We can see that it allocates a char, passes its address to a pointer, followed by printing the three different pieces that make up the pointer in question.</p>

<p>Pretty straightforward stuff so far right? Now let’s dive head first into some assembly!</p>

<p><br /><br /></p>
<h2 id="assembly-breakdown">Assembly breakdown</h2>
<p>Here we see the allocation and assignment of the address for variable our_char to ptr_x:</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">char</span> <span class="n">our_char</span> <span class="o">=</span> <span class="sc">'Q'</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">ptr_x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">our_char</span><span class="p">;</span>
</code></pre>
</div>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="mh">0x004005ad</span>      <span class="n">c645ef51</span>       <span class="k">mov</span> <span class="n">byte</span> <span class="err">[</span><span class="n">local_11h</span><span class="err">]</span><span class="p">,</span> <span class="mh">0x51</span>  <span class="c">; 'Q'</span>
<span class="mh">0x004005b1</span>      <span class="mi">488</span><span class="n">d45ef</span>       <span class="k">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="err">[</span><span class="n">local_11h</span><span class="err">]</span>
<span class="mh">0x004005b5</span>      <span class="mi">488945</span><span class="n">f0</span>       <span class="k">mov</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span><span class="p">,</span> <span class="n">rax</span>
</code></pre>
</div>

<p>At this point, the value “Q” is stored on the stack at local_11h.</p>

<p>The address for the value was loaded into the rax, followed by assigning it to our ptr_x which is also on the stack at local_10h.</p>

<p><br /><br />
Next up is the first print statement. In order to print the address of the pointer variable, the effective address of its position on the stack (local_10h) must be passed to printf:</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"this is your ptr_x addr: 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr_x</span><span class="p">);</span>
</code></pre>
</div>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="mh">0x004005b9</span>      <span class="mi">488</span><span class="n">d45f0</span>       <span class="k">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span>   
<span class="mh">0x004005bd</span>      <span class="mi">4889</span><span class="n">c6</span>         <span class="k">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rax</span> 
<span class="mh">0x004005c0</span>      <span class="n">bfa8064000</span>     <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="k">str</span><span class="p">.</span><span class="n">this_is_your_ptr_x_addr</span><span class="o">:</span><span class="n">_0x_x_n</span> <span class="c">;</span>
<span class="mh">0x004005c5</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="mh">0x004005ca</span>      <span class="n">e8a1feffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">printf</span>         <span class="c">;[1] ; int printf(const char *format)</span>
</code></pre>
</div>

<p><br /><br />
Printing the address of the pointer variable is followed by printing the address it is responsible for storing. In order to acheive this, we simmply derefference the local_10h variable, store it in rax and pass the value to printf:</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"the value stored in ptr_x: 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ptr_x</span><span class="p">);</span>
</code></pre>
</div>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="mh">0x004005cf</span>      <span class="mi">488</span><span class="n">b45f0</span>       <span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span>
<span class="mh">0x004005d3</span>      <span class="mi">4889</span><span class="n">c6</span>         <span class="k">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rax</span>
<span class="mh">0x004005d6</span>      <span class="n">bfc8064000</span>     <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="k">str</span><span class="p">.</span><span class="n">this_is_your_ptr_x_value</span><span class="o">:</span><span class="n">_0x_x_n</span> <span class="c">;        </span>
<span class="mh">0x004005db</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="mh">0x004005e0</span>      <span class="n">e88bfeffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">printf</span>         <span class="c">;[1] ; int printf(const char *format)</span>
</code></pre>
</div>

<p><br /><br />
Finally, the trickiest part, printing the value the pointer is pointing to.</p>

<p>Accomplishing this requires us to perform a double derefference. First, by derefferencing local_10h (our_char address) into a register, followed by derefferencing said address to get the value “Q” stored into the eax.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"here is the value it points to: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr_x</span><span class="p">);</span>
</code></pre>
</div>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="mh">0x004005e5</span>      <span class="mi">488</span><span class="n">b45f0</span>       <span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span>
<span class="mh">0x004005e9</span>      <span class="mi">0</span><span class="n">fb600</span>         <span class="k">movzx</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[rax]</span>
<span class="mh">0x004005ec</span>      <span class="mi">0</span><span class="n">fbec0</span>         <span class="k">movsx</span> <span class="n">eax</span><span class="p">,</span> <span class="n">al</span>
<span class="mh">0x004005ef</span>      <span class="mi">89</span><span class="n">c6</span>           <span class="k">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">eax</span>
<span class="mh">0x004005f1</span>      <span class="n">bfe8064000</span>     <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="k">str</span><span class="p">.</span><span class="n">finally__here_is_the_value_it_points_to</span><span class="o">:</span><span class="n">__c_n</span> <span class="c">;</span>
<span class="mh">0x004005f6</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="mh">0x004005fb</span>      <span class="n">e870feffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">printf</span>         <span class="c">;[1] ; int printf(const char *format)   </span>
</code></pre>
</div>

<p><br /><br />
And there you have it! We’ve printed everything out and our parents are proud. Below you can find the full assembly dump. Until next time!</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="o">/</span> <span class="p">(</span><span class="n">fcn</span><span class="p">)</span> <span class="n">sym</span><span class="p">.</span><span class="n">main</span> <span class="mi">133</span>                                                                                                                  
<span class="o">|</span>   <span class="n">sym</span><span class="p">.</span><span class="n">main</span> <span class="p">()</span><span class="c">;                                                                                                                      </span>
<span class="o">|</span>           <span class="c">; var int local_11h @ rbp-0x11                                                                                            </span>
<span class="o">|</span>           <span class="c">; var int local_10h @ rbp-0x10                                                                                            </span>
<span class="o">|</span>           <span class="c">; var int local_8h @ rbp-0x8                                                                                              </span>
<span class="o">|</span>              <span class="c">; DATA XREF from 0x004004bd (entry0)                                                                                   </span>
<span class="o">|</span>           <span class="mh">0x00400596</span>      <span class="mi">55</span>             <span class="k">push</span> <span class="n">rbp</span>                                                                                   
<span class="o">|</span>           <span class="mh">0x00400597</span>      <span class="mi">4889</span><span class="n">e5</span>         <span class="k">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>                                                                               
<span class="o">|</span>           <span class="mh">0x0040059a</span>      <span class="mi">4883</span><span class="n">ec20</span>       <span class="k">sub</span> <span class="n">rsp</span><span class="p">,</span> <span class="mh">0x20</span>                                                                              
<span class="o">|</span>           <span class="mh">0x0040059e</span>      <span class="mi">64488</span><span class="n">b042528</span><span class="p">.</span>  <span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">fs</span><span class="o">:</span><span class="p">[0x28]</span>    <span class="c">; [0x28:8]=-1 ; '(' ; 40                                       </span>
<span class="o">|</span>           <span class="mh">0x004005a7</span>      <span class="mi">488945</span><span class="n">f8</span>       <span class="k">mov</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_8h</span><span class="err">]</span><span class="p">,</span> <span class="n">rax</span>                                                                  
<span class="o">|</span>           <span class="mh">0x004005ab</span>      <span class="mi">31</span><span class="n">c0</span>           <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>                                                                               
<span class="o">|</span>           <span class="mh">0x004005ad</span>      <span class="n">c645ef51</span>       <span class="k">mov</span> <span class="n">byte</span> <span class="err">[</span><span class="n">local_11h</span><span class="err">]</span><span class="p">,</span> <span class="mh">0x51</span>  <span class="c">; 'Q'                                                          </span>
<span class="o">|</span>           <span class="mh">0x004005b1</span>      <span class="mi">488</span><span class="n">d45ef</span>       <span class="k">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="err">[</span><span class="n">local_11h</span><span class="err">]</span>                                                                       
<span class="o">|</span>           <span class="mh">0x004005b5</span>      <span class="mi">488945</span><span class="n">f0</span>       <span class="k">mov</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span><span class="p">,</span> <span class="n">rax</span>                                                                 
<span class="o">|</span>           <span class="mh">0x004005b9</span>      <span class="mi">488</span><span class="n">d45f0</span>       <span class="k">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span>                                                                       
<span class="o">|</span>           <span class="mh">0x004005bd</span>      <span class="mi">4889</span><span class="n">c6</span>         <span class="k">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rax</span>
<span class="o">|</span>           <span class="mh">0x004005c0</span>      <span class="n">bfa8064000</span>     <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="k">str</span><span class="p">.</span><span class="n">this_is_your_ptr_x_addr</span><span class="o">:</span><span class="n">_0x_x_n</span> <span class="c">; 0x4006a8 ; "this is your ptr_x addr: 0x%x\n"</span>
<span class="o">|</span>           <span class="mh">0x004005c5</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>                                                                                 
<span class="o">|</span>           <span class="mh">0x004005ca</span>      <span class="n">e8a1feffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">printf</span>         <span class="c">;[1] ; int printf(const char *format)                          </span>
<span class="o">|</span>           <span class="mh">0x004005cf</span>      <span class="mi">488</span><span class="n">b45f0</span>       <span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span>                                                                 
<span class="o">|</span>           <span class="mh">0x004005d3</span>      <span class="mi">4889</span><span class="n">c6</span>         <span class="k">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rax</span>                                                                               
<span class="o">|</span>           <span class="mh">0x004005d6</span>      <span class="n">bfc8064000</span>     <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="k">str</span><span class="p">.</span><span class="n">this_is_your_ptr_x_value</span><span class="o">:</span><span class="n">_0x_x_n</span> <span class="c">; 0x4006c8 ; "this is your ptr_x value: 0x%x\</span>
<span class="o">|</span>           <span class="mh">0x004005db</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>                                                                                 
<span class="o">|</span>           <span class="mh">0x004005e0</span>      <span class="n">e88bfeffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">printf</span>         <span class="c">;[1] ; int printf(const char *format)                          </span>
<span class="o">|</span>           <span class="mh">0x004005e5</span>      <span class="mi">488</span><span class="n">b45f0</span>       <span class="k">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_10h</span><span class="err">]</span>                                                                 
<span class="o">|</span>           <span class="mh">0x004005e9</span>      <span class="mi">0</span><span class="n">fb600</span>         <span class="k">movzx</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[rax]</span>                                                                      
<span class="o">|</span>           <span class="mh">0x004005ec</span>      <span class="mi">0</span><span class="n">fbec0</span>         <span class="k">movsx</span> <span class="n">eax</span><span class="p">,</span> <span class="n">al</span>                                                                              
<span class="o">|</span>           <span class="mh">0x004005ef</span>      <span class="mi">89</span><span class="n">c6</span>           <span class="k">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">eax</span>                                                                               
<span class="o">|</span>           <span class="mh">0x004005f1</span>      <span class="n">bfe8064000</span>     <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="k">str</span><span class="p">.</span><span class="n">finally__here_is_the_value_it_points_to</span><span class="o">:</span><span class="n">__c_n</span> <span class="c">; 0x4006e8 ; "finally, here is t</span>
<span class="o">|</span>           <span class="mh">0x004005f6</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>                                                                                 
<span class="o">|</span>           <span class="mh">0x004005fb</span>      <span class="n">e870feffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">printf</span>         <span class="c">;[1] ; int printf(const char *format)                          </span>
<span class="o">|</span>           <span class="mh">0x00400600</span>      <span class="n">b800000000</span>     <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>                                                                                 
<span class="o">|</span>           <span class="mh">0x00400605</span>      <span class="mi">488</span><span class="n">b55f8</span>       <span class="k">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">qword</span> <span class="err">[</span><span class="n">local_8h</span><span class="err">]</span>                                                                  
<span class="o">|</span>           <span class="mh">0x00400609</span>      <span class="mi">644833142528</span><span class="p">.</span>  <span class="k">xor</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">fs</span><span class="o">:</span><span class="p">[0x28]</span>                                                                   
<span class="o">|</span>       <span class="p">,</span><span class="o">=&lt;</span> <span class="mh">0x00400612</span>      <span class="mi">7405</span>           <span class="k">je</span> <span class="mh">0x400619</span>                 <span class="c">;[2]                                                           </span>
<span class="o">|</span>           <span class="mh">0x00400614</span>      <span class="n">e847feffff</span>     <span class="k">call</span> <span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">__stack_chk_fail</span> <span class="c">;[3] ; sym.imp.printf-0x10 ; int printf(const char *format)  </span>
<span class="o">|</span>       <span class="err">`</span><span class="o">-&gt;</span> <span class="mh">0x00400619</span>      <span class="n">c9</span>             <span class="k">leave</span>                                                                              
<span class="err">\</span>           <span class="mh">0x0040061a</span>      <span class="n">c3</span>             <span class="k">ret</span>                                                                                   
</code></pre>
</div>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="/2017/08/18/super_beam.html" title="Super_beam"><img src="/images/think_tank_banner_01.png" alt="Super_beam"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-08-18T00:00:00-04:00"><a href="/2017/08/18/super_beam.html">August 18, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About Zack">Zack</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~5 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2017/08/18/super_beam.html" rel="bookmark" title="Super_beam" itemprop="url">Super_beam</a></h1>
    
  </header>
  <div class="entry-content">
    <h2 id="summary">Summary</h2>
<h3 id="edit-this-vulnerability-has-been-assigned-cve-2017-17763">edit: This vulnerability has been assigned CVE-2017-17763.</h3>

<p>SuperBeam is an excellent file transfer application which enables users from iOS, Android and even a PC to seamlessly transfer files through WiFi direct, over a local LAN or via NFC.</p>

<p>With over 10 PB of file transfers since its creation and well over 10 million downloads, it is certainly a mainstay in the file transfer market.</p>

<p>Playing around with it recently, we were able to spot a few flaws within the file transfer process. Given a properly placed attacker, the possibility to arbitrarily inject data into any given transfer is alive and well!</p>

<p><br /><br /></p>
<h2 id="affected-products">Affected Products</h2>

<p>Versions of SuperBeam / WiFi Direct Share &lt;= 4.1.3</p>

<p><br /><br /></p>
<h2 id="impact">Impact</h2>

<p>During the file transfer process, SuperBeam will offer up the file to be transferred via an HTTP server hosted on the sending device. Any properly positioned attacker is able to arbitrarily inject anything from a text file to an APK onto the receivers’ device through a MiTM attack.</p>

<p>This is accomplished by having the attacker spoof the sending device via ARP Poisoning, while simultaneously running an instance of SuperBeam, whether as an app or the PC version.</p>

<p>The most significant impact appears to be in the context of users making use of SuperBeam to transfer apps. In this type of transfer, a user is inclined to install and run whatever they receive, making this a perfect scenario for the attacker to inject a malicious APK.</p>

<p><br /><br /></p>
<h2 id="technical-details--proof-of-concept">Technical Details / Proof of Concept</h2>

<h3 id="over-the-lan">Over the LAN</h3>

<p>The majority of the research was performed using devices on the same LAN, although via WiFi direct, the results are no different, i.e., sender starts an HTTP server on a LAN and waits for GET requests, no data validation.</p>

<p>Below we will walk through an APK injection scenario / POC. This could just as easily have been a scenario where two parties are exchanging public keys and the attackers injects their own.</p>

<p>Here we see a user initiate a file transfer by selecting an app to send via SuperBeam:
<img src="/images/figure-0.png" alt="user selecting the file they would like to transfer." />
<br /><br /></p>

<p>SuperBeam is now active and has set up a server that will provide the flashlight app APK:
<img src="/images/figure-1.png" alt="super beam HTTP server running." />
<br /><br /></p>

<p>Here we see that the attacker has poisoned the receivers ARP cache, pretending to be the sender at 192.168.2.27:
<img src="/images/figure-2.png" alt="dat arp." />
<br /><br /></p>

<p>The attacker can then run an instance of SuperBeam on a mobile device or a PC and offer up the content they intend to inject into the transfer:
<img src="/images/figure-3.png" alt="PC stands for personal computer." />
<br /><br /></p>

<p><strong>NOTE</strong>: Only the pro version enables downloads to mobile from PC, <strong>inadvertently increasing the attack surface for paying customers only.</strong> Otherwise, the receiver is met with the following:
<img src="/images/figure-4.png" alt="" />
<br /><br /></p>

<p>Next, the receiver will simply scan the QR code provided by the sender, this will issue the following requests:
<img src="/images/figure-5.png" alt="" />
<br /><br /></p>

<p>Since we are injecting our malicious APK via the PC version of SuperBeam, we don’t offer up a jsonlist, hence the 404.</p>

<p>Below are the contents of the jsonlist offered up by the sending device:
<img src="/images/figure-6.png" alt="sweet, sweet metadata." />
<br /><br /></p>

<p>Had this scenario been weaponized, <strong>the attacker could have used the information provided by the jsonlist from the original sender to mirror the application being transferred</strong>, leaving the receiver suspecting nothing.</p>

<p>On the attacker side at this point, we see the request come into our SuperBeam instance instead of the true sender’s instance:
<img src="/images/figure-7.png" alt="dat arp." />
<br /><br /></p>

<p>The receiver will be none the wiser as there are <strong>zero data integrity checks performed on the content received</strong>:
<img src="/images/figure-8.png" alt="what is a keyed HMAC?" />
<br /><br /></p>

<p>Finally, the user simply steps through the installation process and the device is now fully compromised:
<img src="/images/figure-9.png" alt="we did it guys!" />
<br /><br /></p>

<p><br /><br /></p>
<h2 id="over-wifi-direct">Over WiFi Direct</h2>

<p>Due to the nature of the implementation of the WiFi Direct file transfer feature in SuperBeam, the attack described above will have no trouble functioning in a WiFi Direct scenario.</p>

<p>Although some extra effort will be required on the part of the attacker in order to gain access to the LAN created by SuperBeam.</p>

<p>SuperBeam performs a WiFi Direct transfer with the help of a temporary wireless access point, hosted by the device sending files:
<img src="/images/figure-10.png" alt="" />
<br /><br /></p>

<p>After experimenting with how the application sets up this temporary network, a few flaws were uncovered that make it possible for an attacker to break into the network.</p>

<ul>
  <li>
    <p><strong>Static SSID</strong>: As seen in the figure above, the SSID for SuperBeam WiFi direct transfers all follow a similar structure. (Ex: “DIRECT-Yf-S”, DIRECT-<two random="" characters="">-S). Once set, it looks to persist even after deleting the app and reinstalling it.</two></p>
  </li>
  <li>
    <p><strong>Static WPA2 Key</strong>: The temporary network makes use of an 8 character password composed of lower and upper case letters, as well as numbers (no special characters observed during the period of this audit).</p>
  </li>
</ul>

<p>An attacker could capture a handshake between client and server, collect a hash of the key and perform an offline hash cracking attack on the 8 character password.</p>

<p>Since it is the case that the password appears to be static for all transfers initiated by a given sender, once cracked, the attacker has the ability to MiTM every instance of a WiFi Direct transfer offered by the sender in question.</p>

<p><br /><br /></p>
<h2 id="recommended-mitigation">Recommended Mitigation</h2>

<p>The vulnerabilities in the current version of SuperBeam boil down to the lack of any form of data validation.</p>

<p>In order to patch up SuperBeam, the following modifications are recommended:</p>

<p><br /><br /></p>
<h3 id="https">HTTPS</h3>

<p>Offer up all file transfers via HTTPS in order to help make arbitrary MiTM attacks on the file transfer process less trivial.</p>

<p><br /><br /></p>
<h3 id="data-validation">Data validation</h3>

<p>Using a shared secret between the sender and receiver, the files transferred could have HMACs calculated on them.</p>

<p>Even if the attacker could inject their own file into the transfer, without knowledge of the shared secret, the attacker should not be able to calculate a valid HMAC for their injected file.</p>

<p>At the very least, this would provide SuperBeam a way to validate that the data being transferred was not tampered with.</p>

<p><br /><br /></p>
<h3 id="beef-up-wifi-direct">Beef up WiFi Direct</h3>

<p>It would be highly advisable to simply randomize the SSID used by the wifi direct transfer every time a new SuperBeam server starts up.</p>

<p>Not only the SSID but the network key should also change every transfer. If it were randomized, even with a weak 8 character key, the cracked key would only be useful to the attacker for a single wifi direct transfer.</p>

<p>This would render efforts to crack it offline for future use completely futile, as the window of opportunity is reduced to a single transfer.</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->




</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Zack. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-112073698-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>